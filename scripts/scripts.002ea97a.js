"use strict";angular.module("fxyWebApp",["ngAnimate","ngCookies","ngResource","ngSanitize","ngTouch","ui.router","gridstack-angular"]).config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("main",{url:"/",templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).state("vis",{url:"/vis",templateUrl:"views/vis.html",controller:"VisCtrl",controllerAs:"vis",params:{fields:[],types:[],data:[]}}).state("about",{url:"/about",templateUrl:"views/about.html",controller:"AboutCtrl",controllerAs:"about"}),b.otherwise("/")}]),angular.module("fxyWebApp").controller("MainCtrl",["$state",function(a){function b(a){a.stopPropagation(),a.preventDefault();var b=a.dataTransfer.files[0],d=new FileReader;d.onload=c,i?d.readAsBinaryString(b):d.readAsArrayBuffer(b)}function c(b){"undefined"!=typeof console&&console.log("onload",new Date,i,j);var c=b.target.result;if(i)g=h.read(c,{type:"binary",cellNF:!0,cellStyles:!0,cellDates:!0});else{var d=f(c);g=h.read(btoa(d),{type:"base64",cellNF:!0,cellStyles:!0,cellDates:!0})}var k=e(g);"undefined"!=typeof console&&console.log("tabData",new Date),a.go("vis",k)}function d(a){a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy"}function e(a){for(var b=a.SheetNames[0],c=a.Sheets[b],d=h.utils.decode_range(c["!ref"]),e=[],f=d.s.r,g=d.s.c;g<=d.e.c;++g){var i=h.utils.encode_cell({c:g,r:f}),j=c[i],k=j?j.w||""+j.v:"col"+(g+1-d.s.c);e.push(k)}var l=[];++f;for(var g=d.s.c;g<=d.e.c;++g){var i=h.utils.encode_cell({c:g,r:f}),j=c[i],m=j?j.t:"d";switch(m){case"b":case"n":case"d":l.push("number");break;case"s":case"e":default:l.push("string")}}for(var n=[],f=d.s.r+1;f<=d.e.r;++f){for(var o={},g=d.s.c,p=0;g<=d.e.c;++g,++p){var i=h.utils.encode_cell({c:g,r:f}),j=c[i];switch(l[p]){case"number":o[e[p]]=j?+j.v:null;break;case"string":default:o[e[p]]=j?j.w||""+j.v:null}}n.push(o)}return{fields:e,types:l,data:n}}function f(a){for(var b="",c=0,d=10240;c<a.byteLength/d;++c)b+=String.fromCharCode.apply(null,new Uint8Array(a.slice(c*d,c*d+d)));return b+=String.fromCharCode.apply(null,new Uint8Array(a.slice(c*d)))}var g,h=window.XLSX,i="undefined"!=typeof FileReader&&"undefined"!=typeof FileReader.prototype&&"undefined"!=typeof FileReader.prototype.readAsBinaryString,j=!1,k=document.getElementById("drop");k.addEventListener&&(k.addEventListener("dragenter",d,!1),k.addEventListener("dragover",d,!1),k.addEventListener("drop",b,!1))}]),angular.module("fxyWebApp").controller("AboutCtrl",function(){}),angular.module("fxyWebApp").controller("VisCtrl",["$scope","$q","$stateParams",function(a,b,c){var d=c.fields,e=c.types,f=c.data,g=crossfilter(f),h=[],i=0,j=0,k=3,l=2,m=8,n=0;for(var o in d){var p=d[o],q=e[o];if("string"==q){!function(a){var b=g.dimension(function(b){return b[a]}),c=b.group().reduceCount();h.push({x:++i<m?i:(++j,i=0),y:j,width:k,height:l,option:{id:"ch"+ ++n,xAxisLabel:a,yAxisLabel:"频率 (次数)",dimension:b,group:c}})}(p);for(var r in d){var s=d[r],t=e[r];"number"==t&&!function(a,b){var c=g.dimension(function(b){return b[a]}),d=c.group().reduceSum(function(a){return a[b]});h.push({x:++i<m?i:(++j,i=0),y:j,width:k,height:l,option:{id:"ch"+ ++n,xAxisLabel:a,yAxisLabel:b+" 求和",dimension:c,group:d}})}(p,s)}}}a.options={cellHeight:150,verticalMargin:10,animate:!0},a.widgets=h,a.removeWidget=function(b){var c=a.widgets.indexOf(b);a.widgets.splice(c,1)};var u=window.html2canvas;a.save=function(){var a=window.URL||window.webkitURL||window,c=$("[gridstack]"),d=[];c.find("svg").each(function(c,e){var f=$(e).parent(),g=$("<svg>").attr("xmlns","http://www.w3.org/2000/svg").attr("width",$(e).width()).attr("height",$(e).height()).html(e.innerHTML);console.log(g.prop("outerHTML"));var h=b.defer();d.push(h.promise);var i=a.createObjectURL(new Blob([g.prop("outerHTML")],{type:"image/svg+xml;charset=utf-8"})),j=f.parent(),k=new Image;k.src=i,k.onload=function(){var b=$("<canvas>").get(0);b.width=k.width,b.height=k.height;var c=b.getContext("2d");c.drawImage(k,0,0),f.addClass("hidden"),j.append(b),a.revokeObjectURL(i),h.resolve()},k.src=i}),b.all(d).then(function(){u(c).then(function(a){var b="png",c=a.toDataURL(b),d=function(a){a=a.toLowerCase().replace(/jpg/i,"jpeg");var b=a.match(/png|jpeg|bmp|gif/)[0];return"image/"+b};c=c.replace(d(b),"image/octet-stream");var e=function(a,b){var c=document.createElementNS("http://www.w3.org/1999/xhtml","a");c.href=a,c.download=b;var d=document.createEvent("MouseEvents");d.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),c.dispatchEvent(d);var e=$("[gridstack]");e.find("canvas").remove(),e.find(".chart").removeClass("hidden")},f="fxy-"+(new Date).getTime()+"."+b;e(c,f)})})}}]),angular.module("fxyWebApp").directive("fxyChart",function(){function a(a,b,c){var d=a.$eval(c.fxyChart),e=b.find(".chart").attr("id",d.id),f=dc.barChart(e.get(0)),g=[];$.each(d.group.all(),function(a,b){g.push(b.key)}),f.x(d3.scale.ordinal().domain(g)).xUnits(dc.units.ordinal).xAxisLabel(d.xAxisLabel).yAxisLabel(d.yAxisLabel).dimension(d.dimension).group(d.group);var h=b.find(".panel");h.find(".panel-body");window.addResizeListener(b.get(0),function(){var a=b.width()-52,c=b.height()-81,d=Math.floor(a/(g.length+g.length+1));f.margins().right=0,a>100&&c>100&&f.width(a).height(c).gap(d).render()})}return{restrict:"A",link:a}}),angular.module("fxyWebApp").run(["$templateCache",function(a){a.put("views/about.html","<p>This is the about view.</p>"),a.put("views/main.html",'<div class="container"> <h2 class="text-center" style="margin: 50px 0">最简单的数据分析</h2> <div id="drop">只需要把Excel文件拖到这里</div> <div> <h4>支持以下文件格式</h4> <ul> <li>Excel 2007+ XML格式 (XLSX/XLSM)</li> <li>Excel 2007+ 二进制格式 (XLSB)</li> <li>Excel 2003-2004 XML格式 (XML)</li> <li>Excel 97-2004 (XLS BIFF8)</li> <li>Excel 5.0/95 (XLS BIFF5)</li> <li>OpenOffice 格式 (ODS)</li> </ul> </div> </div>'),a.put("views/vis.html",'<div gridstack class="grid-stack" options="options"> <div gridstack-item ng-repeat="w in widgets" class="grid-stack-item" gs-item-x="w.x" gs-item-y="w.y" gs-item-width="w.width" gs-item-height="w.height" gs-item-autopos="1" fxy-chart="w.option"> <div class="grid-stack-item-content"> <div class="panel panel-default" style="margin-bottom: 0"> <div class="panel-heading"> <span class="panel-title">图表名称</span> <button type="button" class="close" aria-label="Close" ng-click="removeWidget(w)"><span aria-hidden="true">&times;</span></button> </div> <div class="panel-body"> <div class="chart"></div> </div> </div> </div> </div> </div> <button class="btn btn-default pull-right" style="position: absolute; bottom: 8px; right: 20px;z-index: 1" ng-click="save()">存为图片</button>')}]);